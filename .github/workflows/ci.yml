# SPDX-License-Identifier: LGPL-3.0-or-later
# Copyright (C) 2023 Christopher Dilks

name: ci

on:
  pull_request:
  push:
    branches:
      - main

defaults:
  run:
    shell: bash

env:
  num_events: 10

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:

# BUILD ---------------------------------------------------------------------------

  build_data_model:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - { repo: EDM4eic, branch: main }
    steps:
      - uses: actions/checkout@v3
      - uses: cvmfs-contrib/github-action-cvmfs@v3
      - uses: eic/run-cvmfs-osg-eic-shell@main
        with:
          platform-release: "jug_xl:nightly"
          setup: environ.sh
          run: |
            echo "[CI] CLONE REPOSITORIES"
            git clone https://github.com/eic/${{matrix.repo}}.git --branch ${{matrix.branch}}
            scripts/configure_CI.sh
            echo "[CI] BUILD REPOSITORIES"
            build.sh ${{matrix.repo}}
      - name: tar_artifacts # workaround: tarball artifacts to preserve executable permissions
        run: tar cvf artifacts.tar prefix ${{matrix.repo}}
      - uses: actions/upload-artifact@v3
        with:
          name: build_data_model
          retention-days: 1
          path: artifacts.tar

  build_github_modules:
    needs:
      - build_data_model
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - { repo: epic,     branch: main     }
          - { repo: irt,      branch: main     }
          - { repo: EICrecon, branch: irt-algo }
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: build_data_model
      - name: untar_artifacts
        run: |
          tar xvf artifacts.tar
          rm -v artifacts.tar
      - uses: cvmfs-contrib/github-action-cvmfs@v3
      - uses: eic/run-cvmfs-osg-eic-shell@main
        with:
          platform-release: "jug_xl:nightly"
          setup: environ.sh
          run: |
            echo "[CI] CLONE REPOSITORIES"
            git clone https://github.com/eic/${{matrix.repo}}.git --branch ${{matrix.branch}}
            scripts/configure_CI.sh
            echo "[CI] BUILD REPOSITORIES"
            build.sh ${{matrix.repo}}
      - name: tar_artifacts # workaround: tarball artifacts to preserve executable permissions
        run: tar cvf artifacts.tar prefix ${{matrix.repo}}
      - uses: actions/upload-artifact@v3
        with:
          name: build_github_modules
          retention-days: 1
          path: artifacts.tar

  build_eicweb_modules:
    needs:
      - build_data_model
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - { repo: reconstruction_benchmarks, repo_path: benchmarks/reconstruction_benchmarks, branch: irt-algo }
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: build_data_model
      - name: untar_artifacts
        run: |
          tar xvf artifacts.tar
          rm -v artifacts.tar
      - uses: cvmfs-contrib/github-action-cvmfs@v3
      - uses: eic/run-cvmfs-osg-eic-shell@main
        with:
          platform-release: "jug_xl:nightly"
          setup: environ.sh
          run: |
            echo "[CI] CLONE REPOSITORIES"
            git clone https://eicweb.phy.anl.gov/EIC/${{matrix.repo_path}}.git --branch ${{matrix.branch}}
            scripts/configure_CI.sh
            echo "[CI] BUILD REPOSITORIES"
            build.sh ${{matrix.repo}}
      - name: tar_artifacts # workaround: tarball artifacts to preserve executable permissions
        run: tar cvf artifacts.tar prefix ${{matrix.repo}}
      - uses: actions/upload-artifact@v3
        with:
          name: build_eicweb_modules
          retention-days: 1
          path: artifacts.tar

  build_local:
    needs:
      - build_github_modules
      - build_eicweb_modules
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: build_github_modules
      - name: untar_artifacts
        run: |
          tar xvf artifacts.tar
          rm -v artifacts.tar
      - uses: actions/download-artifact@v3
        with:
          name: build_eicweb_modules
      - name: untar_artifacts
        run: |
          tar xvf artifacts.tar
          rm -v artifacts.tar
      - uses: cvmfs-contrib/github-action-cvmfs@v3
      - uses: eic/run-cvmfs-osg-eic-shell@main
        with:
          platform-release: "jug_xl:nightly"
          setup: environ.sh
          run: |
            scripts/configure_CI.sh
            echo "[CI] BUILD LOCAL CODE"
            make
      - name: tar_artifacts # workaround: tarball artifacts to preserve executable permissions
        run: tar cvf artifacts.tar prefix bin lib EDM4eic epic irt EICrecon reconstruction_benchmarks
      - uses: actions/upload-artifact@v3
        with:
          name: build_local
          retention-days: 1
          path: artifacts.tar

# PIPELINE: SIMULATION, RECONSTRUCTION, BENCHMARKS ---------------------------------

  pipeline:
    needs:
      - build_local
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - { test_num: 1 }
          - { test_num: 4 }
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: build_local
      - name: untar_artifacts
        run: |
          tar xvf artifacts.tar
          rm -v artifacts.tar
      - uses: cvmfs-contrib/github-action-cvmfs@v3
      - uses: eic/run-cvmfs-osg-eic-shell@main
        with:
          platform-release: "jug_xl:nightly"
          setup: environ.sh
          run: |
            scripts/configure_CI.sh
            echo "[CI] RUN SIMULATION:"
            simulate.py -t ${{matrix.test_num}} -n ${{env.num_events}}
            echo "[CI] EVENT DISPLAY:"
            event_display d s out/sim.edm4hep.root
            echo "[CI] DRAW HITS:"
            draw_hits d
            echo "[CI] RECONSTRUCTION:"
            recon.rb
            echo "[CI] BENCHMARKS:"
            benchmark.rb -b
      - name: tree_artifacts
        run: tree out
      - name: rename_artifacts
        run: mv -v out out.${{matrix.test_num}}
      - uses: actions/upload-artifact@v3
        with:
          name: pipeline
          retention-days: 1
          path: out.${{matrix.test_num}}

# MISCELLANEOUS -------------------------------------------------------------------

  geometry:
    needs:
      - build_local
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - { det: d, detector: DRICH  }
          - { det: p, detector: PFRICH }
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: build_local
      - name: untar_artifacts
        run: |
          tar xvf artifacts.tar
          rm -v artifacts.tar
      - uses: cvmfs-contrib/github-action-cvmfs@v3
      - uses: eic/run-cvmfs-osg-eic-shell@main
        with:
          platform-release: "jug_xl:nightly"
          setup: environ.sh
          run: |
            scripts/configure_CI.sh
            echo "[CI] CREATE TGEO FILE:"
            geometry.sh -${{matrix.det}} -o geo/${{matrix.detector}}_TGeo.root
            echo "[CI] DUMP GEOMETRY CONSTANTS:"
            search_compact_params.sh -e | grep ${{matrix.detector}} | tee geo/${{matrix.detector}}_constants.txt
      - uses: actions/upload-artifact@v3
        with:
          name: geometry
          retention-days: 1
          path: geo

  visual:
    needs:
      - build_local
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: build_local
      - name: untar_artifacts
        run: |
          tar xvf artifacts.tar
          rm -v artifacts.tar
      - uses: cvmfs-contrib/github-action-cvmfs@v3
      - uses: eic/run-cvmfs-osg-eic-shell@main
        with:
          platform-release: "jug_xl:nightly"
          setup: environ.sh
          run: |
            scripts/configure_CI.sh
            echo "[CI] SET DEBUG MODE"
            scripts/set_optics_debug_mode.sh DRICH_debug_sector 1
            echo "[CI] REBUILD epic"
            build.sh epic
            echo "[CI] VISUALIZE:"
            exit | simulate.py -t1 -n1 -v -e pdf
            mv out out.visual
      - uses: actions/upload-artifact@v3
        with:
          name: visual
          retention-days: 1
          path: out.visual

  optics:
    needs:
      - build_local
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: build_local
      - name: untar_artifacts
        run: |
          tar xvf artifacts.tar
          rm -v artifacts.tar
      - uses: cvmfs-contrib/github-action-cvmfs@v3
      - uses: eic/run-cvmfs-osg-eic-shell@main
        with:
          platform-release: "jug_xl:nightly"
          setup: environ.sh
          run: |
            scripts/configure_CI.sh
            echo "[CI] SET DEBUG MODE"
            scripts/set_optics_debug_mode.sh DRICH_debug_optics 1
            echo "[CI] REBUILD epic"
            build.sh epic
            echo "[CI] VISUALIZE:"
            exit | simulate.py -t12 -e pdf
            mv out out.optics
      - uses: actions/upload-artifact@v3
        with:
          name: optics
          retention-days: 1
          path: out.optics

  irt_auxfiles:
    needs:
      - build_local
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
      matrix:
        include:
          - { det: d, detector: DRICH  }
          - { det: p, detector: PFRICH }
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: build_local
      - name: untar_artifacts
        run: |
          tar xvf artifacts.tar
          rm -v artifacts.tar
      - uses: cvmfs-contrib/github-action-cvmfs@v3
      - uses: eic/run-cvmfs-osg-eic-shell@main
        with:
          platform-release: "jug_xl:nightly"
          setup: environ.sh
          run: |
            scripts/configure_CI.sh
            echo "[CI] CREATE IRT AUXFILE:"
            create_irt_auxfile ${{matrix.det}} geo/${{matrix.detector}}_irt_auxfile.root
      - uses: actions/upload-artifact@v3
        with:
          name: irt_auxfiles
          retention-days: 1
          path: geo

# ARTIFACT COLLECTION -------------------------------------------------------------

  collect:
    needs:
      - pipeline
      - geometry
      - visual
      - optics
      - irt_auxfiles
    runs-on: ubuntu-latest
    strategy:
      fail-fast: true
    steps:
      - uses: actions/checkout@v3
      - uses: actions/download-artifact@v3
        with:
          name: pipeline
      - uses: actions/download-artifact@v3
        with:
          name: geometry
      - uses: actions/download-artifact@v3
        with:
          name: visual
      - uses: actions/download-artifact@v3
        with:
          name: optics
      - uses: actions/download-artifact@v3
        with:
          name: irt_auxfiles
      - name: tree_artifacts_before_cull
        run: |
          tree out*
          tree geo
      - name: cull
        run: |
          rm -v out*/*.root
      - name: tree_artifacts_after_cull
        run: |
          tree out*
          tree geo
      - uses: actions/upload-artifact@v3
        with:
          name: _RESULTS
          retention-days: 14
          path: |
            out*
            geo
